<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
	"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Suggested Share</title>

</head>

<body>
	<div id="fb-root"></div>
	<script>
	  window.fbAsyncInit = function() {
	    FB.init({
				appId: '130102540354529',
				status: true,
				cookie: true,
	            xfbml: true
		});
		
		FB.subclass('XFBML.SuggestedShare', 'XFBML.Element', null, {
			share: function(id) {
				FB.ui({ 
					method: 'stream.publish',
					attachment: {
						"href":window.location.href,
						"name":document.title
					},
					target_id: id
				});
			},
			process: function() {
				FB.Event.subscribe('auth.statusChange', FB.bind(this.process, this));
		    	this._ids = this.getAttribute("ids")
		    	this._method = this.getAttribute("method")
		
				if(FB.getSession()) {
					this.dom.innerHTML = "Suggested share with "
					if(this._ids) {
						var pages = FB.Data.query('SELECT page_id, name FROM page WHERE page_id IN ('+this._ids+')');
						var fans = FB.Data.query('SELECT id, name, pic FROM profile WHERE id IN \
					(SELECT uid FROM page_fan WHERE uid IN \
						(SELECT uid2 FROM friend WHERE uid1={0}) AND page_id IN \
						('+ (this._ids) +') \
						)', FB.getSession().uid);
					
			 			FB.Data.waitOn([fans, pages], this.bind(function(args) {
							FB.Array.forEach(fans.value, this.bind(function(fan,i,fans) {
								fan_node = document.createElement('a');
								n = document.createTextNode(fan.name);
								fan_node.href='#'
								fan_node.appendChild(n)
								fan_node.onclick = this.bind(function() {
									this._method ? eval(this._method+"("+fan.id+")") : this.share(fan.id)
									return false
								});
								this.dom.appendChild(fan_node)
								if(i < fans.length-2) {
									this.dom.appendChild(document.createTextNode(", "))
								} else if(i < fans.length - 1) {
									this.dom.appendChild(document.createTextNode(" and "))
								}
							}));
							this.dom.appendChild(document.createTextNode(" who like "))
						
							FB.Array.forEach(pages.value, this.bind(function(page,i,pages) {
								page_node = document.createElement('a');
								n = document.createTextNode(page.name);
								page_node.href= FB._domain.www + 'profile.php?id=' + page.page_id
								page_node.appendChild(n)
								this.dom.appendChild(page_node)
								if(i < pages.length-2) {
									this.dom.appendChild(document.createTextNode(", "))
								} else if(i < pages.length - 1) {
									this.dom.appendChild(document.createTextNode(" or "))
								}
							}))
				 			}));
						}				
					} else {
						this.dom.innerHTML = "Not logged in"
					}
				}
			});
		
		tagInfo = {	xmlns: 'fb',
					localName: 'suggested-share',
					className: 'FB.XFBML.SuggestedShare'},
		FB.XFBML.registerTag(tagInfo);
		
	  };
	  (function() {
	    var e = document.createElement('script'); e.async = true;
	    e.src = document.location.protocol +
	      '//connect.facebook.net/en_US/all.js';
	    document.getElementById('fb-root').appendChild(e);
	  }());
	
	function share(id) {
		// Define a share here
	}
	</script>
	
	<h1>Suggested Share</h1>
<fb:login-button perms="user_likes,friends_likes"></fb:login-button>
<br/>
<fb:suggested-share ids="20531316728, 11204705797, 19292868552"></fb:suggested-share>
</body>
</html>
